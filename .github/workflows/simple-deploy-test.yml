name: Simple Deploy Test

on:
  workflow_dispatch:

env:
  PROJECT_ID: one-event-production
  REGION: asia-southeast1
  REPOSITORY: one-event-repo

jobs:
  simple-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Test GCP Connection
        run: |
          echo "Testing GCP connection..."
          gcloud config list
          gcloud run services list --region=${{ env.REGION }} || echo "No services yet"

      - name: Build and Deploy Backend (Simple)
        run: |
          echo "Building backend..."
          cd one-event-be
          
          # Create simple Dockerfile if not exists
          if [ ! -f Dockerfile ]; then
            cat > Dockerfile << 'EOF'
          FROM node:18-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm ci --only=production
          COPY . .
          RUN npm run build
          EXPOSE 3000
          CMD ["npm", "run", "start:prod"]
          EOF
          fi
          
          # Build and push
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/one-event-backend:test .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/one-event-backend:test
          
          # Deploy to Cloud Run
          gcloud run deploy one-event-api-test \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/one-event-backend:test \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --min-instances=0 \
            --max-instances=2 \
            --memory=1Gi \
            --cpu=1 \
            --timeout=300 \
            --set-env-vars="NODE_ENV=production,PORT=3000" \
            --set-secrets="DATABASE_URL=one-event-db-url-prod:latest,JWT_SECRET=one-event-jwt-secret-prod:latest" || echo "Backend deploy failed"

      - name: Get Deployment URLs
        run: |
          echo "🌐 Deployment URLs:"
          BACKEND_URL=$(gcloud run services describe one-event-api-test --region=${{ env.REGION }} --format="value(status.url)" 2>/dev/null || echo "Backend deployment failed")
          echo "Backend: $BACKEND_URL"
          
          # Test health endpoint
          if [ "$BACKEND_URL" != "Backend deployment failed" ]; then
            echo "Testing backend health..."
            curl -f $BACKEND_URL/health || curl -f $BACKEND_URL/ || echo "Health check failed"
          fi
